steps:
- powershell: |
    switch ("$(Registry)".ToUpper())
    {
        $null { Write-Host ("##vso[task.setvariable variable=RegistryUrl]Test.PyPi") }
        '' { Write-Host ("##vso[task.setvariable variable=RegistryUrl]Test.PyPi") }
        TEST.PYPI { Write-Host ("##vso[task.setvariable variable=RegistryUrl]Test.PyPi") }
        PYPI { Write-Host ("##vso[task.setvariable variable=RegistryUrl]PyPi") }
        default { Write-Host ("##vso[task.setvariable variable=RegistryUrl]$(Registry)") }
    }
  displayName: 'Read registry URL variable'
- template: validateRegistryAndBBVersionSteps.yml

- powershell: |
    $file = '$(System.DefaultWorkingDirectory)/$(Parameters.sourceLocation)/requirements.txt'

    $source = "$(RegistryUrl)"
    $extra_source = "https://pypi.org/simple/"
    $version = "$(BBVersion)"
    $condition = ""
    $pre =  ""

    switch($source){
      PyPi {
        $source = "https://pypi.org/simple/"
        $extra_source = "https://test.pypi.org/simple/"
      }
      Test.PyPi {
        $source = "https://test.pypi.org/simple/"
        $extra_source = "https://pypi.org/simple/"
      }
    }

    switch($version){
      stable {
        $version = ""
      }
      preview {
        $version = ""
        $pre =  "--pre"
      }
      default {
        $condition = "=="
      }
    }

    $script = "botbuilder-integration-aiohttp $condition $version"

    Write-Host "Setting Up Requirements..."
    Write-Host "Source: $source"
    Write-Host "Version: $(BBVersion) `n"

    #Add the $source source at the beginning of requirements
    $content = @(Get-Content $file)
    Set-Content -Path $file -Value ("$pre --index-url $source --extra-index-url $extra_source".Trim())
    Add-Content -Path $file -Value $content

    #Set botbuilder-integration-aiohttp version to empty value
    $content = @(Get-Content $file)
    $matchinfo = Select-String -Path $file -Pattern "botbuilder-integration-aiohttp"

    #matchinfo marks the line number from 1 instead of 0
    $content[$matchinfo.LineNumber - 1] = $script
  
    Set-Content -Path $file -Value $content

    $content = @(Get-Content $file)
    Write-Host "Requirements:"
    $content

  displayName: 'Set BotBuilder Package Version & Registry Url'

- task: AzureCLI@1
  displayName: 'Create resource group and deploy bot'
  inputs:
    azureSubscription: $(AzureSubscription)
    scriptLocation: inlineScript
    inlineScript: |
     az deployment create --name "$(BotName)-RG" --template-file "$(System.DefaultWorkingDirectory)/$(TemplateLocation)" --location "westus" --parameters appId="$(DeployAppId)" appSecret="$(DeployAppSecret)" botId="$(BotName)" botSku=F0 newAppServicePlanName="$(BotName)" newWebAppName="$(BotName)-$(Build.BuildId)" groupName="$(BotName)-RG" groupLocation="westus" newAppServicePlanLocation="westus"

- script: |
   git config --global user.name "GitPythonDeploymentUser"
   git config --global user.email GitPythonDeploymentUser@Pipeline.com
   git init
   git add .
   git commit -m "cibuildtest"
   git remote add azure https://$(AzureDeploymentUser):$(AzureDeploymentPassword)@$(BotName)-$(Build.BuildId).scm.azurewebsites.net:443/$(BotName)-$(Build.BuildId).git
   git push azure master
  workingDirectory: '$(System.DefaultWorkingDirectory)/$(Parameters.sourceLocation)'
  displayName: 'Git bot deployment'
