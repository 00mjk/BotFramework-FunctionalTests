steps:
- task: AzureCLI@1
  displayName: 'Create resource group and deploy bot'
  inputs:
    azureSubscription: $(AzureSubscription)
    scriptLocation: inlineScript
    inlineScript: |
     az deployment create --name "$(BotName)-RG" --template-file "$(System.DefaultWorkingDirectory)/$(TemplateLocation)" --location "westus" --parameters appId="$(DeployAppId)" appSecret="$(DeployAppSecret)" botId="$(BotName)" botSku=F0 newAppServicePlanName="$(BotName)" newWebAppName="$(BotName)-$(Build.BuildId)" groupName="$(BotName)-RG" groupLocation="westus" newAppServicePlanLocation="westus"

- powershell: |
    if(-Not ($null -eq $env:BOTBUILDERPACKAGEVERSION))
    {
        Write-Host "SdkVersion variable found. Set to $env:BOTBUILDERPACKAGEVERSION"

        $file = '$(System.DefaultWorkingDirectory)/$(Parameters.sourceLocation)/requirements.txt'

        #Add the test.pypi source at the beginning of requirements
        $content = Get-Content $file
        Set-Content -Path $file -Value "--extra-index-url https://test.pypi.org/simple/"
        Add-Content -Path $file -Value $content

        #Set botbuilder-integration-aiohttp version to value specified
        $content = Get-Content $file
        $matchinfo = Select-String -Path $file -Pattern "botbuilder-integration-aiohttp"

        #matchinfo marks the line number from 1 instead of 0
        $content[$matchinfo.LineNumber - 1] = "botbuilder-integration-aiohttp==$env:BOTBUILDERPACKAGEVERSION"
        Set-Content -Path $file -Value $content

        $content = Get-Content $file
        Write-Host "requirements.txt:"
        Write-Host $content
    }
  displayName: 'Set BotBuilder version value'
  condition: ne(variables['BotBuilderPackageVersion'], '')

- script: |
   mv $(System.DefaultWorkingDirectory)/$(Parameters.sourceLocation)/deployment-scripts/* $(System.DefaultWorkingDirectory)/$(Parameters.sourceLocation)
   git config --global user.name "GitPythonDeploymentUser"
   git config --global user.email GitPythonDeploymentUser@Pipeline.com
   git init
   git add .
   git commit -m "cibuildtest"
   git remote add azure https://$(AzureDeploymentUser):$(AzureDeploymentPassword)@$(BotName)-$(Build.BuildId).scm.azurewebsites.net:443/$(BotName)-$(Build.BuildId).git
   git push azure master
  workingDirectory: '$(System.DefaultWorkingDirectory)/$(Parameters.sourceLocation)'
  displayName: 'Git bot deployment'
