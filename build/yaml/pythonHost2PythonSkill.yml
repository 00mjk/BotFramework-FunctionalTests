#
# Optionally deploy a Python Host bot and a Python Skill bot and run functional tests. (No build stage.)
#

# "name" here defines the build number format. Build number is accessed via $(Build.BuildNumber)
name: $(Build.BuildId)
trigger: none
pr: none

variables:
  BuildPlatform: 'any cpu'
  BuildConfiguration: 'Debug'
  system_accesstoken: $(System.AccessToken)  # Allow OAuth token access.
  # AzureDeploymentPassword: define this in Azure
  # AzureDeploymentUser: define this in Azure
  # AzureSubscription: define this in Azure
  # BotBuilderPackageVersionHost (Optional): define this in Azure
  # BotBuilderPackageVersionSkill (Optional): define this in Azure
  # DeleteResourceGroup (Optional): define this in Azure
  # NextBuild (Optional): define this in Azure
  # PyPyHostAppId: define this in Azure
  # PyPyHostAppSecret: define this in Azure
  # PyPyHostBotName: define this in Azure
  # PyPySkillAppId: define this in Azure
  # PyPySkillAppSecret: define this in Azure
  # PyPySkillBotName: define this in Azure

pool:
  vmImage: 'windows-2019'

stages:
- stage: Prepare
  condition: and(succeeded(), in(variables['Build.Reason'], 'Schedule', 'Manual'))
  jobs:
    - job: Delete_Preexisting_Resources
      variables:
        HostBotName: $(PyPyHostBotName)
        SkillBotName: $(PyPySkillBotName)
      steps:
      - template: cleanResourcesStep.yml
        
- stage: Tag
  condition: always()
  jobs:
    - job: Tag
      steps:
      - task: colinsalmcorner.colinsalmcorner-buildtasks.tag-build-task.tagBuildOrRelease@0
        displayName: 'Tag Build with Build.Reason=$(Build.Reason) NextBuild=$(NextBuild)'
        inputs:
          tags: |
            Build.Reason=$(Build.Reason)
            NextBuild=$(NextBuild)
        continueOnError: true

- stage: Deploy
  condition: and(always(), in(variables['Build.Reason'], 'Schedule', 'Manual'))
  pool:
    vmImage: 'ubuntu-latest'
  jobs:
    - job: Deploy_Host
      variables:
        BotName: $(PyPyHostBotName)
        DeployAppId: $(PyPyHostAppId)
        DeployAppSecret: $(PyPyHostAppSecret)
        BotBuilderPackageVersion: $[variables.BotBuilderPackageVersionHost]
        Parameters.sourceLocation: 'SkillsFunctionalTests/python/host'
        TemplateLocation: 'SkillsFunctionalTests/python/host/deploymentTemplates/template-with-new-rg.json'
      steps:
      - powershell: |
         Write-host "Setting config file"
         $file = "$(System.DefaultWorkingDirectory)/$(Parameters.sourceLocation)/.env";
         $content = Get-Content -Raw $file | ConvertFrom-StringData;
         $content.SKILL_BOT_APP_ID = "$(PyPySkillAppId)";
         $content.SKILL_BOT_ENDPOINT = "https://$(PyPySkillBotName)-$(Build.BuildId).azurewebsites.net/api/messages";
         $content.SKILL_HOST_ENDPOINT = "https://$(PyPyHostBotName)-$(Build.BuildId).azurewebsites.net/api/skills";

         Clear-Content $file;
         foreach ($key in $content.keys) { Add-Content $file "$key=$($content.$key)" };
        displayName: 'Update .env file'

      - template: pythonDeploySteps.yml

    - job: Deploy_Skill
      variables:
        BotName: $(PyPySkillBotName)
        DeployAppId: $(PyPySkillAppId)
        DeployAppSecret: $(PyPySkillAppSecret)
        BotBuilderPackageVersion: $[variables.BotBuilderPackageVersionSkill]
        Parameters.sourceLocation: 'SkillsFunctionalTests/python/skill'
        TemplateLocation: 'SkillsFunctionalTests/python/skill/deploymentTemplates/template-with-new-rg.json'
      steps:
      - template: pythonDeploySteps.yml

- stage: Test
  dependsOn: Deploy
  jobs:
    - job: Run_Functional_Test
      variables:
        HostBotName: $(PyPyHostBotName)
        Parameters.project: 'SkillsFunctionalTests/tests/SkillFunctionalTests/SkillFunctionalTests.csproj'
        Parameters.solution: 'SkillsFunctionalTests/tests/SkillFunctionalTests.sln'
      steps:
      - template: functionalTestSteps.yml

- stage: Cleanup
  dependsOn:
  - Deploy
  - Test
  condition: and(always(), in(variables['Build.Reason'], 'Schedule', 'Manual'))
  jobs:
    - job: Delete_RG
      steps:
      - task: AzureCLI@1
        displayName: 'Delete Resource Group'
        inputs:
          azureSubscription: $(AzureSubscription)
          scriptLocation: inlineScript
          inlineScript: |
           call az group delete -n "$(PyPyHostBotName)-RG" --yes
           call az group delete -n "$(PyPySkillBotName)-RG" --yes
        condition: and(always(), ne(variables['DeleteResourceGroup'], 'false'))

- stage: QueueNext
  condition: always()
  jobs:
    - job: TriggerBuild
      steps:
      - task: benjhuser.tfs-extensions-build-tasks.trigger-build-task.TriggerBuild@3
        displayName: 'Trigger build $(NextBuild)'
        inputs:
          buildDefinition: '$(NextBuild)'
          queueBuildForUserThatTriggeredBuild: true
          password: '$(PipelinesPersonalAccessToken)'
          enableBuildInQueueCondition: true
          blockingBuildsList: '$(NextBuild)'
        continueOnError: true
        condition: and(succeededOrFailed(), ne(variables['Build.Reason'], 'Manual'), ne(variables['NextBuild'], ''), ne(variables['PipelinesPersonalAccessToken'], ''))